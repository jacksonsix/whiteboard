<html>
  <head>
<link rel="stylesheet" type="text/css" media="screen" href="https://cdn.conversejs.org/6.0.0/dist/converse.min.css">
<script src="https://cdn.conversejs.org/6.0.0/dist/converse.min.js" charset="utf-8"></script>

  </head>
  <body>
      <textarea id='out'></textarea>
      <button id='send'>send</button>
      <textarea id='rec'></textarea>
	
      <script>
	const mplugin =  {
	    _converse: null,
	    _super:null,
	    initialize: function () {
		_converse = this._converse;
		//_super = this.__super__;
		_converse.api.listen.on('message', obj => {
		    //console.log(obj.stanza.innerHTML);
		    this.outmessage('out: ' +obj.stanza.innerHTML);
		 
		});
       
	    },
	    overrides: {
		ChatBoxView: {                
                    showMessage: function (attrs) {
			if(attrs.attributes['message'] &&  attrs.attributes['message'].substring(0,3) !=='$$$'){
			    this.__super__.showMessage(attrs);
			}
		
                    }
		}
            },
	    send: function(txt){
		var msg = converse.env.$msg({from:  'tom@whiteboard-k42jz', to:'jianlong@whiteboard-k42jz', type: 'chat'})
		    .c('body')
		    .t('$$$' + txt);
		    _converse.api.send(msg);
	    },
	    outmessage: onmessage
	};

    converse.plugins.add('myplugin', mplugin);
    converse.initialize({
        bosh_service_url: 'http://192.168.0.134:5280/bosh', // Please use this connection manager only for testing purposes
        show_controlbox_by_default: true,
	whitelisted_plugins: ['myplugin']
    });
    function onmessage(msg){
	console.log(msg);
	let rec = document.getElementById('rec');
	rec.innerHTML += msg;
    }
  // send out
  let btn = document.getElementById('send');
	btn.addEventListener('click',function(evt){
	let out = document.getElementById('out');
        mplugin.send(out.value);
      
  });
  // on receive ,display
  
</script>
  </body>
</html>
